# 🏷️ גישה משולבת: AI מתייג → AI קובע insertion points → Python ממזג

## הרעיון:

**שלב 1:** AI מתייג טווחי שורות בתוך עמודים (שנה, חודש, מיקום)  
**שלב 2:** AI קובע insertion points - לכל קטע מהספר של רוחמה, AI קובע איפה הוא צריך להיכנס בספר של יהודה  
**שלב 3:** Python ממזג לפי insertion points (שומר על הסדר המקורי של הספר של יהודה)

---

## 🎯 למה זה טוב?

### ✅ **יתרונות:**

1. **AI מבין הקשר טוב יותר:**
   - מזהה תאריכים גם אם הם לא מפורשים
   - מזהה חודשים גם אם הם לא כתובים במפורש
   - מזהה מיקומים גם אם הם לא מוזכרים ישירות

2. **Python עושה MERGE מדויק:**
   - מסדר לפי שנה → חודש → מיקום
   - מהיר ואמין
   - לא משמיט כלום

3. **התסריט = הטקסט מהספרים:**
   - AI רק מתייג, לא יוצר תוכן חדש
   - הטקסט נשאר מהספרים עצמם

---

## 📋 תהליך העבודה:

### שלב 1: Python יוצר תבנית לתיוג

```bash
cd movie/scripts
python 01_tag_pages_with_ai.py
```

**מה זה עושה:**
- קורא את כל העמודים משני הספרים
- יוצר קובץ JSON עם כל העמודים
- כל עמוד כולל: טקסט מלא, שורות ממוספרות, פרק, עמוד
- מוכן לתיוג טווחי שורות על ידי AI

**תוצאה:** `pages_for_ai_tagging.json`

---

### שלב 2: AI מתייג כל עמוד

**אוטומטי (מומלץ):**
```bash
python 02_tag_pages_with_gemini.py
```

**או ידני:**
1. פתח את `pages_for_ai_tagging.json`
2. שלח ל-ChatGPT/Claude את ההוראות המפורטות

**👉 קרא את ההוראות המפורטות:** [AI_TAGGING_INSTRUCTIONS.md](AI_TAGGING_INSTRUCTIONS.md)

**בקצרה:**
- AI מתייג טווחי שורות בתוך כל עמוד עם: line_start, line_end, year, month, location, locations, characters, confidence
- כל טווח שורות מתוייג בנפרד לפי התוכן שלו
- AI משתמש בהבנת הקשר כדי לזהות תאריכים ומיקומים גם אם הם לא מפורשים
- שמור את התוצאה כ-`pages_tagged_by_ai.json`

---

### שלב 2b: AI קובע insertion points (חלוקה לפסקאות)

```bash
python 02b_determine_insertion_points.py
```

**מה זה עושה:**
- AI קורא את הספר של יהודה במלואו כדי להבין את ההקשר הכרונולוגי והנרטיבי
- **לכל עמוד מהספר של רוחמה:**
  - AI מחלק את העמוד לפסקאות בעלות הקשר (contextually coherent paragraphs)
  - כל פסקה יכולה להיות שורה אחת, כמה שורות, או חלק מעמוד
  - לכל פסקה, AI קובע:
    - `source_line_start`, `source_line_end`: טווח השורות של הפסקה בספר של רוחמה
    - `insert_after_page`: מספר עמוד בספר של יהודה אחרי איזה להכניס
    - `insert_after_line`: מספר שורה בספר של יהודה אחרי איזה להכניס (0 = אחרי כל העמוד)
    - `insert_reason`: סיבה קצרה למה כאן (לפי הקשר כרונולוגי/נרטיבי)
    - `confidence`: רמת ביטחון (high/medium/low)
- AI משתמש בהבנת הקשר כדי לקבוע איפה כל פסקה מתאימה

**למה פסקאות ולא עמודים שלמים?**
- ✅ פסקאות שומרות על הקשר מדויק יותר
- ✅ כל פסקה יכולה להיכנס בנקודה המתאימה לה בספר של יהודה
- ✅ שמירה על רצף פסקתי בספר של רוחמה
- ✅ שילוב חלק יותר בספר של יהודה

**תוצאה:** `insertion_points.json` - ברמת פסקאות

**דוגמה:**
- אם עמוד 5 בספר של רוחמה מתאר הגעה ליפו ב-1904 ואז מעבר לבאר טוביה
- ועמוד 9 בספר של יהודה מתאר ילדות ברוסיה (לפני 1904)
- AI יחלק את עמוד 5 לפסקאות:
  - פסקה 1 (שורות 1-5): הגעה ליפו → `insert_after_page: 9, insert_after_line: 0`
  - פסקה 2 (שורות 6-10): מעבר לבאר טוביה → נקודת הכנסה אחרת

---

### שלב 3: Python ממזג לפי insertion points

```bash
python 03_merge_books_with_ai_tags.py
```

**מה זה עושה:**
- קורא את התיוגים מ-AI (`pages_tagged_by_ai.json`)
- קורא את ה-insertion points (`insertion_points.json`) - ברמת פסקאות
- שומר על הסדר המקורי של הספר של יהודה (שדות ראשונים)
- מכניס פסקאות מהספר של רוחמה בנקודות שקבע AI (לפי `insert_after_page` ו-`insert_after_line`)
- יוצר טקסט ממוזג תוך שמירה על הקשר לעמוד ולשורות

**תוצאה:** `merged_books_with_ai_tags.txt`

**הערה:** אם אין `insertion_points.json`, הסקריפט ישתמש במיון כרונולוגי (שיטה ישנה) כגיבוי.

---

## 🔄 השוואה לגישות אחרות:

| קריטריון | Python בלבד | AI מתייג → Python ממזג |
|----------|-------------|------------------------|
| **זיהוי תאריכים** | ⚠️ חיפוש מילים | ✅ הבנת הקשר |
| **זיהוי חודשים** | ❌ לא יכול | ✅ יכול |
| **זיהוי מיקומים** | ⚠️ חיפוש מילים | ✅ הבנת הקשר |
| **מהירות MERGE** | ✅ מהיר | ✅ מהיר |
| **דיוק MERGE** | ✅ מדויק | ✅ מדויק יותר |

---

## 💡 דוגמה:

### עמוד מהספר:
```
יהודה מור עלה ארצה כילד ב-1904, השנה בה החלה העלייה השנייה.
הוא הגיע ליפו בחודש ניסן, ומשם המשיך לבאר טוביה.
```

### Python בלבד מזהה:
- שנה: 1904 ✅
- חודש: ❌ לא מזהה
- מיקום: יפו, באר טוביה ✅

### AI מתייג:
- year: 1904 ✅
- month: ניסן ✅ (מזהה מהקשר)
- location: יפו ✅
- locations: ["יפו", "באר טוביה"] ✅
- characters: ["יהודה"] ✅
- confidence: high ✅

---

## 📝 פורמט התיוג:

```json
{
  "id": "beit_markovski_page_014",
  "book_id": "beit_markovski",
  "book_name": "בית מרקובסקי",
  "page_number": 14,
  "chapter": "באר־טוביה",
  "full_text": "...",
  "lines": [
    {"line_number": 1, "text": "...", "is_empty": false},
    {"line_number": 2, "text": "...", "is_empty": false},
    ...
  ],
  "line_tags": [
    {
      "line_start": 1,
      "line_end": 5,
      "year": 1904,
      "month": "ניסן",
      "location": "beer_tuvia",
      "locations": ["beer_tuvia", "jaffa"],
      "characters": ["yehuda", "yosef"],
      "confidence": "high"
    },
    {
      "line_start": 6,
      "line_end": 10,
      "year": 1904,
      "month": null,
      "location": "jaffa",
      ...
    }
  ]
}
```

---

## 🎯 מתי להשתמש בגישה הזו?

### ✅ **כדאי להשתמש אם:**
- אתה רוצה זיהוי מדויק יותר של תאריכים ומיקומים
- אתה רוצה לזהות גם חודשים
- אתה מוכן להשקיע זמן ב-AI tagging
- אתה רוצה MERGE מדויק יותר

### ⚠️ **לא כדאי אם:**
- אתה רוצה משהו מהיר ופשוט
- אתה לא רוצה להשתמש ב-AI
- התיוג הבסיסי של Python מספיק לך

---

## 📊 סיכום:

**גישה משולבת:**
1. Python יוצר תבנית עם שורות ממוספרות ✅
2. AI מתייג טווחי שורות בתוך כל עמוד ✅
3. AI מחלק את הספר של רוחמה לפסקאות וקובע insertion points (לכל פסקה, איפה להיכנס בספר של יהודה) ✅
4. Python ממזג לפי insertion points תוך שמירה על הסדר המקורי של הספר של יהודה ✅

**יתרונות:**
- הספר של יהודה נשאר בסדר המקורי שלו (מסגרת הנרטיב נשמרת) ✅
- AI מבין את ההקשר הכרונולוגי והנרטיבי בין שני הספרים ✅
- פסקאות מהספר של רוחמה נכנסות בנקודות המתאימות לפי הקשר, לא רק לפי זמן ✅
- שמירה על רצף פסקתי בספר של רוחמה ✅
- זיהוי מדויק יותר (AI מבין הקשר) ✅
- התסריט = הטקסט מהספרים (AI רק מתייג ומחלק לפסקאות) ✅

**זה הגישה הכי מדויקת ויציבה!** 🎯
